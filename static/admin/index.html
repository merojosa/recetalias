<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Content Manager</title>
	</head>
	<body>
	<!-- Include the script that builds the page and powers Decap CMS -->
	<script src="https://unpkg.com/decap-cms@^3.9.0/dist/decap-cms.js"></script>
	<script>
		/**
		 * Generate a URL-friendly slug from a string
		 * @param {string} text - The text to slugify
		 * @returns {string} - Slugified text
		 */
		function slugify(text) {
			return text
				.toString()
				.toLowerCase()
				.trim()
				// Replace accented characters
				.normalize('NFD')
				.replace(/[\u0300-\u036f]/g, '')
				// Replace spaces and underscores with hyphens
				.replace(/[\s_]+/g, '-')
				// Remove all non-word chars except hyphens
				.replace(/[^\w-]+/g, '')
				// Replace multiple hyphens with single hyphen
				.replace(/--+/g, '-')
				// Remove leading/trailing hyphens
				.replace(/^-+|-+$/g, '');
		}

		/**
		 * Auto-generate IDs for ingredients based on their names
		 */
		CMS.registerEventListener({
			name: 'preSave',
			handler: ({ entry }) => {
				const collection = entry.get('collection');
				
				// Only process ingredients collection
				if (collection !== 'ingredients') return;

				const data = entry.get('data');
				const ingredients = data.get('ingredients');

				if (!ingredients) return;

				// Convert to plain JS array
				const ingredientArray = ingredients.toJS ? ingredients.toJS() : ingredients;
				
				// Track used IDs to handle duplicates
				const usedIds = new Set();
				
				// Generate IDs for each ingredient
				const updatedIngredients = ingredientArray.map((ingredient) => {
					// If ingredient already has a valid ID, keep it
					if (ingredient.id && ingredient.id.trim()) {
						usedIds.add(ingredient.id);
						return ingredient;
					}
					
					// Generate base ID from name
					let baseId = slugify(ingredient.name);
					let finalId = baseId;
					let counter = 1;
					
					// Handle duplicates by appending numbers
					while (usedIds.has(finalId)) {
						counter++;
						finalId = `${baseId}-${counter}`;
					}
					
					usedIds.add(finalId);
					
					return {
						...ingredient,
						id: finalId
					};
				});
				
				// Update the entry with new IDs
				return entry.get('data').set('ingredients', updatedIngredients);
			}
		});

		// Custom validation for unique recipe IDs
		CMS.registerEventListener({
				name: 'preSave',
				handler: ({ entry }) => {
					const data = entry.get('data');
					const recipes = data.get('recipes');

					if (!recipes) return;

					// Convert to plain JS array
					const recipeArray = recipes.toJS ? recipes.toJS() : recipes;

					// Check for duplicate IDs
					const ids = recipeArray.map((recipe) => recipe.id).filter(Boolean);
					const duplicates = ids.filter((id, index) => ids.indexOf(id) !== index);

					if (duplicates.length > 0) {
						const uniqueDuplicates = [...new Set(duplicates)];
						throw new Error(
							`Duplicate recipe ID(s) found: ${uniqueDuplicates.join(', ')}. Each recipe must have a unique ID.`
						);
					}
				}
			});

		// Refresh page when ingredients are saved to update relation widget
		CMS.registerEventListener({
			name: 'postSave',
			handler: ({ entry }) => {
				const collection = entry.get('collection');
				
				if (collection === 'ingredients') {
					setTimeout(() => {
						window.location.reload();
					}, 500);
				}
			}
		});
		</script>
	</body>
</html>
